assert {![have_board linux] &&
       ![have_board rpi]  &&
       ![have_board rpi3]  &&
       ![have_board imx53_qsb_tz]}

if {[have_cmd_switch --autopilot]} {
	assert {![have_board virt_qemu_riscv]} \
		"Autopilot mode is not supported on this platform."
}

create_boot_directory

import_from_depot [depot_user]/src/[base_src] \
                  [depot_user]/pkg/[drivers_nic_pkg] \
                  [depot_user]/src/report_rom \
                  [depot_user]/src/fs_rom \
                  [depot_user]/src/fs_tool \
                  [depot_user]/src/vfs \
                  [depot_user]/src/vfs_lxip \
                  [depot_user]/src/vfs_pipe \
                  [depot_user]/src/fetchurl \
                  [depot_user]/src/libc \
                  [depot_user]/src/libssh \
                  [depot_user]/src/openssl \
                  [depot_user]/src/zlib \
                  [depot_user]/src/curl \
                  [depot_user]/src/init \
                  [depot_user]/src/chroot \
                  [depot_user]/src/extract \
                  [depot_user]/src/nic_router \
                  [depot_user]/src/libarchive \
                  [depot_user]/src/liblzma \
                  [depot_user]/src/verify

proc depot_user_download { user } {
	return [exec cat [select_from_repositories sculpt/depot/$user/download]] }

proc depot_user_pubkey { user } {
	return [exec cat [select_from_repositories sculpt/depot/$user/pubkey]] }

install_config {
config
+ parent-provides
  + service ROM
  + service IRQ
  + service IO_MEM
  + service IO_PORT
  + service PD
  + service RM
  + service CPU
  + service LOG

+ default-route
  + any-service
    + parent
    + any-child

+ default | caps: 100 | ram: 1M

+ start timer
  + provides | + service Timer

+ start drivers | caps: 1200 | ram: 32M | managing_system: yes
  + binary init
  + route
    + service ROM | label: config | + parent | label: drivers.config
    + service Timer               | + child timer
    + service Uplink              | + child nic_router
    + any-service                 | + parent

+ start nic_router | caps: 200 | ram: 10M
  + provides
    + service Nic
    + service Uplink
  + config | verbose_domain_state: yes
    + policy | label_prefix: depot_download | domain: downlink
    + policy | label_prefix: drivers        | domain: uplink
    + domain uplink
      + nat | domain: downlink | tcp-ports: 16384 | udp-ports: 16384 | icmp-ids: 16384
    + domain downlink | interface: 10.0.3.1/24
      + dhcp-server | ip_first: 10.0.3.2 | ip_last: 10.0.3.2 | dns_config_from: uplink
      + tcp  | dst: 0.0.0.0/0 | + permit-any | domain: uplink
      + udp  | dst: 0.0.0.0/0 | + permit-any | domain: uplink
      + icmp | dst: 0.0.0.0/0                | domain: uplink

+ start vfs | ram: 20M
  + provides | + service File_system
  + config
    + vfs
    | + dir depot
    | | + dir genodelabs
    | |   + ram
    | |   + inline download | : } [depot_user_download genodelabs] {
    | |   + rom pubkey | label: genodelabs.pub | binary: no
    | + dir public
    |   + ram
    + policy | label_prefix: depot_download -> depot ->  | root: /depot  | writeable: yes
    + policy | label_prefix: depot_download -> public -> | root: /public | writeable: yes

+ start report_rom
  + provides
    + service Report
    + service ROM
  + config | verbose: yes

+ start depot_download | caps: 2000 | ram: 72M
  + binary init
  + route
    + service ROM | label: config | + parent | label: depot_download.config
    + service Report              | + child report_rom
    + service Nic                 | + child nic_router
    + service File_system         | + child vfs
    + any-service
      + parent
      + any-child
-
}


set fd [open [run_dir]/genode/installation w]
puts $fd {
installation | arch: x86_64
+ archive | path: genodelabs/pkg/wm/2019-03-17
+ archive | path: genodelabs/bin/x86_64/backdrop/2019-03-17
+ index   | path: genodelabs/index/19.02
+ index   | path: genodelabs/index/19.03
-
}
close $fd


set fd [open [run_dir]/genode/genodelabs.pub w]
puts $fd [depot_user_pubkey genodelabs]
close $fd


copy_file [genode_dir]/repos/gems/recipes/raw/depot_download/depot_download.config \
          [run_dir]/genode/depot_download.config

build { app/depot_download_manager app/depot_query }

build_boot_image [build_artifacts]

append qemu_args " -nographic "
append_qemu_nic_args


# watch the state reports generated by the depot-download manager
set expected_pattern {}
append expected_pattern {.*path.*genodelabs/pkg/wm/2019-03-17.*state.*done.*}
append expected_pattern {.*path.*genodelabs/bin/x86_64/backdrop/2019-03-17.*state.*done.*}
append expected_pattern {.*path.*genodelabs/index/19.02.*state.*done.*}
append expected_pattern {.*path.*genodelabs/index/19.03.*state.*failed.*}

run_genode_until $expected_pattern 150
